# 5. 데이터 집계
데이터를 그룹화해서 각종 통계 지표를 제공하기 위해 엘라스틱서치에서는 집계 기능을 공식적으로 제공한다. (SQL에서 Group by 연산과 비슷)

## 5.1 집계
집계는 데이터를 그룹화하고 통계를 구하는 기능이다.

1. 엘라스틱서치와 데이터 분석 - 일반적인 통계 프로그램은 배치 방식으로 데이터를 처리한다. 엘라스틱서치는 많은 양의 데이터를 조각내어 관리한다. 그래서 배치 처리보다 좀 더 실시간에 가깝게 문서를 처리할 수 있다. 엘라스틱서치는 집계를 여러 개 중첩해 사용할 수 있고, 범위, 날짜, 위치 정보도 집계할 수 있다.

```
{
    "aggs": {
        "movie_no_agg": {
            "terms": {
                "field": "movie_no"
            }, 
            "aggs": {
                "ratings_agg": {
                    "sum": {
                        "field": "ratings"
                    }
                }
            }
        }
    }
}
```

2. 엘라스틱서치가 집계에 사용하는 기술 - 집계는 검색보다 더 많은 리소스를 사용한다. 집계시 다음을 주의해야 한다.
   * 캐시 : 캐시는 질의의 결과를 임시 버퍼에 둔다. 이후 같은 질의에 대해 버퍼에 보관된 결과를 반환한다. 캐시를 적용하는 것만으로도 인덱스의 성능을 대폭 향상시킬 수 있다. 캐시는 엘라스틱서치의 conf 폴더 안에 elasticsearch.yml 파일을 수정해 활성화할 수 있다.
   * Node Query Cache : 노드의 모든 샤드가 공유하는 LRU 캐시다. 캐시 용량이 가득차면 사용량이 가장 적은 데이터를 삭제하고 새로운 결과값을 캐싱한다.
   * Shard request Cache : 샤드는 데이터를 분산 저장하기 위한 단위로서 그 자체가 온전한 기능을 가진 독립 인덱스라고 할 수 있다. Shard request Cache는 바로 이 샤드에서 수행된 쿼리의 결과를 캐싱한다. 샤드의 내용이 변경되면 캐시가 삭제되기 때문에 업데이트가 빈번한 인덱스에서는 오히려 성능 저하를 일으킬 수 있다.
   * Field data Cache : 엘라스틱서치가 필드에서 집계 연산을 수행할 때는 모든 필드 값을 메모리에 로드한다. Field data Cache는 집계가 계산되는 동안 필드의 값을 메모리에 보관한다.
   
3. Aggregation API 이해하기