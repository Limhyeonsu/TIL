# 7. 한글 검색 확장 기능
엘라스틱서치로 검색 사이트 구축시 한글 처리에 많은 문제가 있다. 한글 형태소 분석기를 이용하면 많은 문제를 해결할 수 있지만 유니코드의 특성상 키보드 입력에 대한 실시간 처리는 형태소 분석기만으로는 완벽하게 처리하기 불가능하다.

엘라스틱서치에서 기본적으로 제공하는 Suggest API가 키워드 자동완성을 지원하지만 한글 키워드를 대상으로 할 때는 정상적으로 동작하지 않기 때문에 한글 키워드를 지원하려면 직접 자동완성을 구현해야 한다.

## 7.1 Suggest API 소개
사용자가 키워드를 잘못 입력했거나 검색한 결과가 없을 경우 어떻게 보여주어야 할까? 검색엔진 특성상 분리된 텀과 완전히 일치하지 않으면 검색 결과로 제공되지 않을 가능성이 매우 크다. 이러한 경우 검색 결과의 만족도를 높이기 위해 엘라스틱서치는 도큐먼트 내에 존재하는 단어를 대상으로 비슷한 키워드를 변경해서 제시하는 교정 기능을 제공한다.
가령 검색어의 철자를 잘못 입력 하는 경우 어떻게든 비슷한 내용을 보여 줄 수 있는 방안을 찾아야 하는데 그 방법중 하나가 단어의 철자를 수정해서 다른 단어를 제공하거나 제안된 내용을 보여주는 맞춤법 검사기(Spell Checker) 기능이다.

* Term Suggest API : 추천 단어 제안, 잘못된 철자에 대해 해당 인덱스의 특정 필드에서 가장 유사한 단어를 추천해주는 오타 교정 방법
* Completion Suggest API : 자동완성 제안, 사용자가 입력을 완료하기 전에 자동완성을 사용하여 검색어를 예측해서 보여준다. (영문에서는 잘 동작하지만 한글에서는 X)
* Phrase Suggest API : 추천 문장 제안
* Context Suggest API : 추천 문맥 제안

### Term Suggest API
이것은 편집거리를 사용해 비슷한 단어를 제안한다. 편집거리 척도란 어떤 문자열이 다른 문자열과 얼마나 비슷한가를 편집거리를 사용해 알아볼 수 있다. 두 문자열 사이의 편집거리는 하나의 문자열을 다른 문자열로 바꾸는 데 필요한 편집 횟수를 말한다.

측정 과정을 진행할 때 한 문자열을 다른 문자열로 바꾸는데 필요한 삽입, 삭제, 치환 연산의 총 수행 횟수의 합계를 편집거리라 한다. 예시(319~321p)

한글의 경우 Term Suggest를 사용해도 데이터가 추천되지 않는다. 하지만 한글의 자소를 분해해서 문서를 처리한 후 색인할 경우 영문과 동일하게 추천 기능을 구현하는 것이 가능해진다. (자바카페의 플러그인 사용)

### Completion Suggest API
검색 사이트에서는 일반적으로 사용자의 검색을 효율적으로 돕기 위해 자동완성 기능을 제공한다. 자동완성은 글자가 입력될 때마다 검색 결과를 보여줘야 하기 때문에 응답속도가 매우 중요하다. Completion Suggest API를 사용하게 되면 엘라스틱서치 내부적으로 FST(검색어가 모두 메모리에 로드되는 구조)를 사용한다.

자동완성 기능을 사용하기 위해서는 데이터 타입을 `completion`으로 설정해서 인덱스를 생성해야 한다. completion을 사용하려면 필드에 데이터를 넣을 때 검색이 가능해지는 형태로 가공해서 넣어야 한다. 예) 부분일치를 하고 싶다면 원하는 부분을 분리해서 배열형태로 만들어야 한다. 예시(322~328p)

Completion Suggest API가 전방일치 방식밖에 지원하지 않기 때문에 색인시 데이터를 가공해야 한다.

## 7.2 맞춤법 검사기
### Term Suggester API를 이용한 오타 교저
Term Suggester API를 이용하면 인덱스 내에 있는 단어를 이용해 비슷한 단어가 추천된다. 기본적으로 한글의 경우는 잘 동작하지 않으므로 한글에 적용할 수 있는 플러그인을 별도로 설치한다. 

```
# 자바 카페 플러그인 설치
$ wget https://github.com/javacafe-project/elastic-book-etc/raw/master/plugin/javacafe-analyzer-6.4.3.zip

# 플러그인을 엘라스틱 서치에 설치
$ ./bin/elasticsearch-plugin install file://<플러그인 절대경로>/javacafe-analyzer-6.4.3.zip

# 엘라스틱 서치에 설치된 플러그인 목록 조화
$ ./bin/elasticsearch-plugin list

# 필터
* javacafe_chosung : 한글 초성 분석 필터
* javacafe_jamo : 한글 자모 분석 필터
* javacafe_eng2kor : 영한 오타 변환 필터
* javacafe_kor2eng : 한영 오타 변환 필터
* javacafe_spell : 한글 맞춤법 검사 필터
```

예제(330~333p)

1) 인덱스 생성 : 인덱스 생성시 필터 항목에 javacafe_spell 필터를 추가한다.
2) 매핑 설정 : 매핑에 자동 완성이 적용될 suggest 필드를 정의하고 analyzer 속성에 외부 분석기를 사요앟ㄴ다.
3) 오타 교정 데이터 색인
4) 오타 교정 API 요청

사용자가 입력한 단어와 비슷한 단어를 찾기 위해 javacafe_spell 필터는 내부적으로 색인된 모든 데이터를 자소 단위로 분해해서 생성한다. 그리고 요청된 검색어도 자소로 분해해서 비슷한 데이터를 찾는다. 이때는 모든 데이터가 자소 단위로 분해됐기 때문에 편집거리 계산이 가능해진다.

### 한영/영한 오타 교정
한글 검색어를 영문 자판으로 설정해 두고 검색하거나 영문 검색어를 한글 자판으로 설정해 놓고 검색하는 경우가 있다. 이런 경우의 오타를 교정할 때는 다음 두 가지 방식중 어떤 방식을 사용자에게 제공할지 생각해야 한다.
1. 해당 단어를 추천만 하는 방법
2. 해당 단어를 추천하고 추천한 단어로 검색 결과를 보여주는 방법

검색 서비스에 따라 위 두 가지 방법을 선택적으로 사용하고 있다.

예제(337~343p)

1) 인덱스 생성 : 한영 오차 교정과 영한 오차 교정을 위해 javacafe_kor2eng 필터와 javacafe_eng2kor 필터를 추가한다.
2) 매핑 설정
3) 오타 교정 데이터 색인
4) 오타 교정 API 요청