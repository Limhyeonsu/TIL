# 4. 데이터 검색
엘라스틱서치는 인덱스에 저장된 문서를 검색할 수 있도록 다양한 검색 기능을 제공한다. 특정 문장이 검색어로 요청되면 분석기를 통해 분석된 토큰의 일치 여부를 판단해서 그 결과에 점수를 매긴다. 

엘라스틱서치에서는 다양한 검색 조건을 충족시키기 위해 Query DSL이라는 특수한 쿼리 문법을 제공한다.

## 4.1 검색 API
문장은 색인 시점에 텀으로 분해된다. 검색시에는 이 텀을 일치시켜야 검색이 가능해진다.

엘라스틱서치는 색인 시점에 Analyzer를 통해 분석된 텀을 Term, 출현빈도, 문서번호와 같이 역색인 구조로 만들어 내부적으로 저장한다. 검색 시점에는 분석 가능한 데이터를 구분해서 분석이 가능할 경우 분석기를 이용해 분석을 수행한다. 이를 통해 검색 시점에도 텀을 얻을 수 있고, 해당 텀으로 역색인 구조를 이용해 문서를 찾고 이를 통해 스코어를 계산해서 결과로 제공한다.

### 검색 질의 표현 방식
엘라스틱서치에서 제공하는 검색 API는 기본적으로 질의를 기반으로 동작한다. 
* URI 검색 : HTTP GET 요청을 활용하는 방식으로 파라미터를 Key=Value 형태로 전달하는 방식이다. 파라미터로 표현할 수 있는 표현의 한계로 복잡한 질의를 작성하는 것은 불가능하다. `GET movie_search/_search?q=prdtYear:2018`
* Request Body : HTTP 요청시 Body에 검색할 칼럼과 검색어를 JSON 형태로 표현해서 전달하는 방식이다. JSON 형태의 표현을 효율적으로 하기 위해 엘라스틱서치에서는 Query DSL이라는 특별한 문법을 지원한다. 이를 이용해서 URI 방식에 비해 다양한 조합의 검색 쿼리를 작성할 수 있다.

```
POST movie_search/_search
{
    "query": {
        "term": {
            "prdtYear": "2018"
        }
    }
}
```

### URI 검색
URI 검색은 단순하고 사용하기 편리하지만 복잡한 질의문을 입력하기 힘들다는 치명적인 단점이 있다. 또한 엘라스틱서치에서 제공하는 모든 검색 옵션을 사용할 수 없다. 장점으로는 웹브라우저를 이용해 빠르게 테스트할 수 있다는 점이다.

URI 검색은 검색 조건을 몇 가지만 추가해도 검색식이 너무 복잡해져서 사용하기가 불편하고 가독성도 무척 떨어진다. 그러므로 간단한 조회가 필요할 경우에만 사용하고 가능한 한 Request Body 방식의 검색을 사용하자.

<img src="img/URI검색파라미터.jpeg" width="500px">

### Request Body 검색
Request Body 검색은 질의 내용을 JSON 형태로 작성하며, 이때 Query DSL이라 불리는 도메인 전용 언어 문법을 사용한다.