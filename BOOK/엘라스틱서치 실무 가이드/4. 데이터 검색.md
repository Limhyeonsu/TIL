# 4. 데이터 검색
엘라스틱서치는 인덱스에 저장된 문서를 검색할 수 있도록 다양한 검색 기능을 제공한다. 특정 문장이 검색어로 요청되면 분석기를 통해 분석된 토큰의 일치 여부를 판단해서 그 결과에 점수를 매긴다. 

엘라스틱서치에서는 다양한 검색 조건을 충족시키기 위해 Query DSL이라는 특수한 쿼리 문법을 제공한다.

## 4.1 검색 API
문장은 색인 시점에 텀으로 분해된다. 검색시에는 이 텀을 일치시켜야 검색이 가능해진다.

엘라스틱서치는 색인 시점에 Analyzer를 통해 분석된 텀을 Term, 출현빈도, 문서번호와 같이 역색인 구조로 만들어 내부적으로 저장한다. 검색 시점에는 분석 가능한 데이터를 구분해서 분석이 가능할 경우 분석기를 이용해 분석을 수행한다. 이를 통해 검색 시점에도 텀을 얻을 수 있고, 해당 텀으로 역색인 구조를 이용해 문서를 찾고 이를 통해 스코어를 계산해서 결과로 제공한다.

### 검색 질의 표현 방식
엘라스틱서치에서 제공하는 검색 API는 기본적으로 질의를 기반으로 동작한다. 
* URI 검색 : HTTP GET 요청을 활용하는 방식으로 파라미터를 Key=Value 형태로 전달하는 방식이다. 파라미터로 표현할 수 있는 표현의 한계로 복잡한 질의를 작성하는 것은 불가능하다. `GET movie_search/_search?q=prdtYear:2018`
* Request Body : HTTP 요청시 Body에 검색할 칼럼과 검색어를 JSON 형태로 표현해서 전달하는 방식이다. JSON 형태의 표현을 효율적으로 하기 위해 엘라스틱서치에서는 Query DSL이라는 특별한 문법을 지원한다. 이를 이용해서 URI 방식에 비해 다양한 조합의 검색 쿼리를 작성할 수 있다.

```
POST movie_search/_search
{
    "query": {
        "term": {
            "prdtYear": "2018"
        }
    }
}
```

### URI 검색
URI 검색은 단순하고 사용하기 편리하지만 복잡한 질의문을 입력하기 힘들다는 치명적인 단점이 있다. 또한 엘라스틱서치에서 제공하는 모든 검색 옵션을 사용할 수 없다. 장점으로는 웹브라우저를 이용해 빠르게 테스트할 수 있다는 점이다.

URI 검색은 검색 조건을 몇 가지만 추가해도 검색식이 너무 복잡해져서 사용하기가 불편하고 가독성도 무척 떨어진다. 그러므로 간단한 조회가 필요할 경우에만 사용하고 가능한 한 Request Body 방식의 검색을 사용하자.

<img src="img/URI검색파라미터.jpeg" width="500px">

### Request Body 검색
Request Body 검색은 질의 내용을 JSON 형태로 작성하며, 이때 Query DSL이라 불리는 도메인 전용 언어 문법을 사용한다.

## 4.2 Query DSL 이해하기
Query DSL을 이용하면 여러 개의 질의를 조합하거나 질의 결과에 대해 다시 검색을 수행하는 등 기존의 URI 검색보다 강력한 검색이 가능해진다. 엘라스틱서치에서는 정밀한 검색을 위해 JSON 구조를 기반으로 한 Query DSL을 제공한다.

### Query DSL 쿼리의 구조
Query DSL로 쿼리를 작성하려면 미리 정의된 문법에 따라 JSON 구조를 작성해야 한다.

```
{
    "size":         // 리턴받는 결과의 개수 지정
    "from":         // 몇 번째 문서부터 가져올지 지정
    "timeout":      // 검색을 요청해서 결과를 받는 데 까지 걸리는 시간
    
    "_source": {}   // 검색시 필요한 필드만 출력하고 싶을 때 사용
    "query": {}     // 검색 조건문이 들어가야 하는 공간
    "aggs": {}      // 통계 및 집계 데이터를 사용할 때 사용하는 공간
    "sort": {}      // 문서 결과를 어떻게 출력할지에 대한 조건을 사용하는 공간
}
```

### Query DSL 쿼리와 필터
Query DSL을 이용해 검색 질의를 작성할 때 조금만 조건이 복잡해지더라도 여러 개의 작은 질의를 조합해서 사용해야 한다. 작은 질의는 두 가지 형태로 나눠서 생각할 수 있다.
1. 실제 분석기에 의한 전문 분석이 필요한 경우(쿼리 컨텍스트) : 전문 검색시 사용, 분석기에 의해 분석 수행, 연관성 관련 score 계산, 상대적으로 느림
2. 단순히 yes/no로 판단할 수 있는 조건 검색의 경우(필터 컨텍스트) : 조건 검색시 사용, yes/no로 단순 판별 가능, 연관성 관련 계산을 하지 않음, 상대적으로 빠름

두 가지중 어떤 방식을 사용하더라도 대부분 같은 결과를 얻을 수 있다. 하지만 내부적으로 검색 과정이나 성능이 크게 달라지기 때문에 가능한 용도를 맞춰 사용하자.

__쿼리 컨텍스트__ : 문서가 쿼리와 얼마나 유사한지 스코어로 계산한다. 질의 요청시마다 엘라스틱서치 내부의 루씬을 이용해 계산을 수행한다, 일반적으로 전문 검색에 많이 사용되고 캐싱되지 않고 디스크 연산을 수행하기 때문에 상대적으로 느리다.
```
POST movie_search/_search
{
    "query": {
        "match": {
            "movieNm": "기묘한 가족"
        }
    }
}
```

__필터 컨텍스트__ : 쿼리의 조건과 문서가 일치하는지를 구분한다. 별도로 스코어를 계산하지 않고 단순 매칭 여부를 검사한다. 자주 사용되는 결과는 내부에 캐싱한다. 기본적으로 메모리 연산을 수행하여 상대적으로 빠르다.
```
POST movie_search/_search
{
    "query": {
        "bool": {
            "must": [
                {
                    "match_all":{}
                }
            ],
            "filter": {
                "term": {
                    "repGenerNm": "다큐멘터리"
                }
            }
        }
    }
}
```

### Query DSL의 주요 파라미터
Query DSL은 다양한 파라미터를 옵션으로 제공한다.
* Multi Index 검색 : 기본적으로 모든 검색 요청은 Multi Index 및 Multi Type 검색이 가능하다. 그래서 다수의 인덱스를 검색해야 할 때도 한 번의 요청으로 검색 결과를 얻을 수 있다. `POST movie_search,movie_auto/_search` 각 인덱스가 공통적인 필드는 갖고 있지만 서로 다른 스키마 구조를 갖고 있는 경우라도 Multi Index 쿼리를 이용하면 다수의 비정형 데이터를 가지고 있는 경우에도 한번에 검색할 수 있다. 
* 쿼리 결과 페이징 : 페이징 처리를 하기 위해서는 문서의 시작을 나타내는 from 파라미터를 사용하고, 문서의 개수를 나타내기 위해 size 파라미터를 사용하면 된다. (기본값 from=0, size=5) 엘라스틱서치는 페이징된 해당 문서만 선택적으로 가져오는 것이 아닌 모든 데이터를 읽는다. 
* 쿼리 결과 정렬 : sort 파라미터를 사용하여 지정한 필드에 따라 정렬할 수 있다.
* _source 필드 필터링 : 검색 결과는 기본적으로 JSON 데이터로 제공된다. 실제 데이터는 _source 항목 아래에 존재한다. 항상 모든 필더를 볼 필요가 없을 때 필요에 따라 특정 필드를 검색 결과에서 제거하고 싶을 때도 있을 것이다. 그럴때 _source 필드를 필터링하여 원하는 필드만 조회되게 지정할 수 있다. 
* 범위 검색 : lt(<), gt(>), lte(<=), gte(>=)
* operator 설정 : 엘라스틱서치는 검색시 문장이 들어올 경우 `기본적으로 OR 연산`으로 동작한다. 실무에서는 AND 연산을 사용해야할 경우가 많다. 그럴때 operator 파라미터를 통해 연산자를 명시적으로 지정하 and 나 or 연산자를 명시적으로 지정할 수 있다.
* minimum_should_match 설정 :  or 연산을 수행하는 경우 사용할 수 있는 옵션이 있다. or 연산의 경우 검색 결과가 너무 많아질 수 있다. 이 경우 텀의 개수가 몇 개 이상 매칭될 때만 검색 결과로 나오게 할 수 있는데 그 파라미터가 minimum_should_match이다. 이 파라미터를 사용하면 or 연산으로 and 연산과 비슷한 효과를 낼 수 있다.
* fuzziness 설정 : 이 파라미터를 사용하면 단순히 같은 값을 찾는 Match Query를 `유사한 값을 찾는 Fuzzy Query로 변경`할 수 있다. 사용자가 실수로 오타를 입력한 경우 텀이 일치하지 않아 검색되지 않는다 Fuzziness 설정을 사용하면 검색이 가능해진다.
* boost 설정 : 이 설정은 검색에서 가장 많이 사용하는 파라미터중 하나다. 관련성이 높은 필드나 키워드에 가중치를 더 줄 수 있게 해준다. 

```
POST movie_search/_search
{
    "query": {
        "multi_match": {
            "query": "Fly",
            "fields": ["movieNm^3", "movieNmEn"] -- movieNm에 ^3 가중치 값으로 3을 곱하게 한다.
        }
    }
}
```
