# 9. 값의 콜렉션 매핑
## 01. 값 콜렉션
JPA는 String, Int와 같은 단순 값에 대한 콜렉션을 지원한다.

JPA가 지원하는 콜렉션 타입
* List : 인덱스 기반의 순서가 있는 값 목록
* Set : 중복을 허용하지 않는 집합
* Map : (키, 값) 쌍을 갖는 맵
* Collection : 중복을 허용하는 집합

## 02. 단순 값 List 매핑
```java
@Entity
public class Itinerary {
    //..
    
    @ElementCollection
    @CollectionTable(
        name = "itinerary_site",
        joinColumns = @JoinColumn(name = "itinerary_id"))
    @OrderColumn(name = "list_idx")
    @Column(name = "site") 
    private List<String> sites;
    
    //..
}
```

* @ElementCollection : 매핑 대상이 값 콜렉션임을 지정
* @CollectionTable : 콜렉션을 저장할 때 사용할 테이블 지정
* @OrderColumn : 콜렉션 테이블에서 리스트의 인덱스 값을 저장할 칼럼 이름 지정

### 2.1 List의 저장과 조회
```java
em.getTransaction().begin();
List<String> sitess = Arrays.asList("경복궁", "청계천", "명동", "인사동");
Itinerary itinerary = new Itinerary("광화문-종로 인근", "설명", sitess);
em.persist(itinerary);
em.getTransaction().commit();

```
@ElementCollection 애노테이션의 fetch 속성은 기본값이 FetchType.LAZY이다. 

### 2.2 List 변경
콜렉션을 변경하면 관련 테이블의 데이터도 함께 변경한다. 콜렉션의 값을 변경하는 방법은 다음과 같이 두 가지가 있다.
* changeSites() 메서드를 이용해서 sites 속성에 새로운 콜렉션 할당 -> itinerary 엔티티 객체를 구한뒤 새로운 리스트 객체를 changeSites() 에 전달하는 경우 커밋 시점에 기존 콜렉션 데이터를 삭제한 뒤 새로운 콜렉션 데이터를 추가하는 쿼리가 실행된다.
* getSites() 메서드로 구한 콜렉션을 수정 -> 콜렉션의 일부만 변경하는 경우 기존 항목 변경시에는 update 쿼리실행, 새로 추가하는 경우 insert 쿼리를 실행한다.

### 2.3 List 전체 삭제
콜렉션 데이터를 삭제하는 경우 콜렉션의 clear() 메서드를 사용하면 된다. 그렇게 되면 delete 쿼리를 실행해서 콜렉션 테이블에서 엔티티와 연관된 데이터를 삭제한다.

위 방법 외에 또 다른 방법으로는 콜렉션에 null을 할당하는 방법이 있다. null을 할당하는 경우에도 동일하게 delete 쿼리를 실행한다.

## 03. 밸류 객체 List 매핑
단순 값 타입 콜렉션 대신 밸류 객체 콜렉션을 갖는 경우에도 DB 테이블 구조는 동일하다. 

```java
@Embeddable
public class SiteInfo {
    private String site;
    private int time;
    
    //...
}

public class Itinerary {
    //...
    
    
    @ElementCollection
    @CollectionTable(
        name = "itinerary_site",
        joinColumns = @JoinColumn(name = "itinerary_id"))
    @OrderColumn(name = "list_idx")
    private List<SiteInfo> sites;
}

```

@Embeddable로 매핑한 클래스의 칼럼 이름 대신 다른 칼럼 이름을 사용하고 싶다면 @AttributeOverride 애노테이션이나 @AttributeOverrides 애노테이션을 사용하면 된다.

## 04. List 요소와 null
getSites()로 구한 List 객체의 두 번째 항목을 null로 설정한 경우 List의 길이가 4일 때 List의 두 번째 항목은 null로 저장되고 길이는 그대로 4인 리스트가 된다.

## 05. 단순 값 Set 매핑
집합은 중복을 허용하지 않는 콜렉션이다. 

|user_keyword|
|-----|
|user_email|
|keyword|

```java
public class User {
    //...
    
    @ElementCollection  //fetch 기본은 LAZY
    @CollectionTable(
        name = "user_keyword",
        joinColumns = @JoinColumn(name = "user_email"))
    @Column(name = "keyword") 
    private Set<String> keywords = new HashSet();
    
    //...

}


// 저장과 조회
em.getTransaction().begin();
User user = new User("user@email.com", "사용자", new Date());
Set<String> keywords = new HashSet<>();
keywords.add("역사");
keywords.add("유적");
keywords.add("전통음식");
user.setKeywords(keywords);
em.persist(user);
em.getTransaction().commit();


//변경1) keywords 값 중 "서울" delete, inert "한성"
User user = em.find(User.class, email);
Set<String> keywords = user.getKeywords();
keywords.remove("서울");
keywords.add("한성");

//변경2) user_email에 해당하는 데이터에 대해서 전체 삭제 후 insert
User user = em.find(User.class, email);
Set<String> keywords = new HashSet<>();
keywords.add("한성");
keywords.add("부여");
user.setKeywords(keywords);

//변경3)clear()로 집합을 모두 지우고 add()하는 경우 전체 Set을 삭제하기 위한 delete 실행 X, 기존 Set과 비교해서 삭제된 요소만 delete 새로 추가된 요소만 insert
User user = em.find(User.class, email);
Set<String> keywords = user.getKeywords();
keywords.clear();
keywords.add("한성");
keywords.add("부여");

//전체 삭제 3가지 방법
user.getKeywords().clear();
user.setKeywords(Collections.emptySet());
user.setKeywords(null);

```

