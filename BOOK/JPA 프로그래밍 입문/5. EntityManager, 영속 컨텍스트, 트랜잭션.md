# 5. EntityManager, 영속 컨텍스트, 트랜잭션
## 01. EntityManager 와 영속 컨텍스트
EntityManager find()로 읽어온 객체는 영속 객체이다. 영속 객체는 DB에 보관된 데이터에 매핑되는 메모리상의 객체를 의미한다.

save()를 이용해 새로운 객체를 추가하면 해당 객체는 영속 객체가 되고, EntityManager가 관리한다. 그리고 트랜잭션 커밋 시점에 save()로 추가한 영속 객체를 DB에 반영한다.

영속 객체를 관리할 때 영속 컨텍스트라는 집합을 사용하는데 이 집합은 일종의 메모리 저장소로서 EntityManager가 관리할 엔티티 객체를 보관한다.

<img src="img/영속컨텍스트.jpeg" width="500px">

EntityManager는 트랜잭션 커밋 시점에 (or flush) 영속컨텍스트에 보관된 영속 객체의 변경 내역을 추적해서 DB에 반영한다. 데이터가 바뀐 객체는 update 쿼리를 이용해서 변경하고, 새롭게 추가된 객체는 insert 쿼리를 이용해서 삽입하고, 삭제 처리한 객체는 delete 쿼리를 이용해서 삭제한다.

### 영속 컨텍스트와 캐시
영속 컨텍스트는 엔티티타입과 식별자를 키로 사용하는 보관소이다. 동일 식별자를 갖는 엔티티에 대한 캐시 역할을 한다. 같은 트랜잭션 내에서 find()를 여러번 사용하는 경우 영속 컨텍스트에 보관된 같은 식별자를 갖는 엔티티 객체를 찾아서 리턴한다. 이 캐시는 영속 컨텍스트와 관련 있으므로 EntityManager 객체를 종료하기 전까지만 유요하다.

## 02. EntityManager 종류
* 애플리케이션 관리 EntityManager : 애플리케이션에서 직접 EntityManager를 생성하고 종료한다.
  * EntityManagerFactory 생성과 종료
  * EntityManagerFactory 를 이용해서 EntityManager를 생성하고 종료 처리
* 컨테이너 관리 EntityManager : JBoss EAP, 웹로직, TomEE와 같은 JEE 컨테이너가 EntityManager의 생성과 종료를 관리한다.
  * JEE 컨테이너에서 EntityManagerFactory와 EntityManager의 라이프사이클을 관리한다.
  * @PersistenceContext 애노테이션을 사용하여 구할 수 있다.