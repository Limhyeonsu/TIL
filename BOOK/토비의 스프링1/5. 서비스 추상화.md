# 5. 서비스 추상화
## 5.1 사용자 레벨 관리 기능 추가
간단한 CRUD만 있었던 UserDao에 간단한 비즈니스 로직을 추가해본다. 

* 사용자 레벨은 BASIC, SILVER, GOLD 세 가지 중 하나
* 처음 가입시 BASIC 레벨, 이후 한 단계씩 업그레이드 된다.
* 가입 후 50회 이상 로그인시 BASIC에서 SILVER 레벨이 된다.
* SILVER 레벨이면서 30번 이상 추천을 받으면 GOLD 레벨이 된다.
* 사용자 레벨 변경 작업은 일정한 주기를 가지고 일괄적으로 진행된다. 변경 작업 전 조건을 충족하더라도 레벨의 변경이 일어나지 않는다.

### 필드 추가

```java
//1. Level enum 생성
public enum Level {
    BASIC(1), SILVER(2), GOLD(3);
    
    private final int value;
    
    Level(int velue) {
        this.value = value;
    }
    
    public int intValue() {
        return value;
    }
    
    public static Level valueOf(int value) {
        switch(value) {
            case 1: return BASIC;
            case 2: return SILVER;
            case 3: return GOLD;
            default: throw new AssertionError("Unknown value: " + value);
        }
    }
}

//2. User 필드 추가
public class User {
    //...
    Level level;
    int login;
    int recommend;
    
    // getter/setter ..
    
}

//3. 필드 추가에 따른 테스트 코드 수정

//4. UserDaoJdbc 수정
public class UserDaoJdbc implement UserDao {
    //...
    private RowMapper<User> userMapper = 
        new RowMapper<User>() {
            public User mapRow(ResultSet rs, int rowNum) throws SQLException {
                User user = new User();
                user.setId(rs.getString("id"));
                user.setName(rs.getString("name"));
                user.setPassword(rs.getString("password"));
                user.setLevel(Level.valueOf(rs.getInt("level")));
                user.setLogin(rs.getInt("login"));
                user.setRecommend(rs.getInt("recommend"));
                return user;
            }
        
        }
    
    public void add(User user) {
        this.jdbcTemplate.update("insert into users(id, name, password, level, login, recommend) values(?,?,?,?,?,?)", user.getId(), user.getName(), user.getPassword(), user.getLevel().intValue(), user.getLogin(), user.getRecommend());
    }
    
}
```
add 할 때 Level 타입의 level 필드는 DB에 저장할 수 있는 SQL 타입이 아니므로 정수형으로 값을 변환해주어야 한다. (user.getLevel().intValue()) 반대로 조회할 때는 ResultSet에서 DB 타입인 int로 level 정보를 가져와서 Level.valueOf()를 이용해 int 값을 Level 타입의 enum 오브젝트로 만들어서 setLevel() 매서드에 넣어줘야 한다.

### 사용자 수정 기능 추가
사용자 정보에 대한 수정이 발생했을때 SQL문에 WHERE 절을 빼먹는 경우 테스트로는 검증하지 못하는 오류가 발생할 수 있다. 따라서 수정하지 말아야할 로우의 내용이 그래도 남아있는지 확인도 필요하다.

수정 테스트의 경우 위 문제를 해결하기 위해
1. UPDATE, DELETE 처럼 테이블의 내용에 영향을 주는 SQL을 실행하면 영향받은 로우의 갯수를 반환해주는데 로우의 갯수를 검증한다.
2. 테스트 코드를 보강해서 원하는 사용자 외의 정보는 변경되지 않았음을 직접 확인한다.

### UserService.upgradeLevels()
사용자 관리 로직은 UserDaoJdbc에 두는것은 적당하지 않다. 비즈니스 로직을 다루기 위한 클래스를 새로 생성한다. (UserService)

UserService는 UserDao의 구현 클래스가 바뀌어도 영향받지 않도록 해야한다. 데이터 액세스 로직이 바뀌었다고 비즈니스 로직 코드를 수정하는 일이 있어서는 안 된다. 따라서 DAO의 인터페이스를 사용하고 DI를 적용해야 한다. DI를 적용하기 위해 UserService도 스프링 빈으로 등록한다.

```java
public class UserService {
    UserDao userDao;
    
    //setter

}
```

```xml
<bean id="userService" class="springbook.user.service.UserService">
    <property name="userDao" ref="userDao"/>
</bean>

<bean id="userDao" class="springbook.user.dao.UserDaoJdbc">
    <property name="dataSource" ref="dataSource"/>
</bean>
```

```java
public void upgradeLevels() {
    List<User> users = userDao.getAll();
    for(User user : users) {
        Boolean changed = null;
        if(user.getLevel() == Level.BASIC && user.getLogin() >= 50) {
            user.setLevel(Level.SILVER);
            changed = true;
        } else if(user.getLevel() == Level.SILVER && user.getRecommend() >= 30) {
            user.setLevel(Level.GOLD);
            changed = true;
        } else if(user.getLevel() == Level.GOLD) {
            changed = false;
        } else {
            changed = false;
        }
        
        if(changed) {
            userDao.update(user);
        }
    }
}

```

upgradeLevels() 테스트 - 적어도 가능한 모든 조건을 하나씩은 확인해봐야 한다. 
```java
@RunWith(...)
@ContextConfingration(...)
public class UserServiceTest {
    
    @Autowired
    UserService userService;
    List<User> users;
    
    @Before
    public void setUp() {
        users = Arrays.asList(
            new User("bumjin", "박범진", "p1", Level.BASIC, 49, 0),
            new User("joytouch", "강명성", "p2", Level.BASIC, 50, 0),
            new User("erwins", "신승한", "p3", Level.SILVER, 60, 29),
            new User("madnite1", "이상호", "p4", Level.SILVER, 60, 30),
            new User("green", "오민규", "p5", Level.GOLD, 100, 100)
        );
    }
    
    @Test
    public void upgradeLevels() {
        userDao.deleteAll();
        for(User user : users) userDao.add(user);
        
        userService.upgradeLevels();
        checkLevel(users.get(0), Level.BASIC);
        checkLevel(users.get(1), Level.SILVER);
        checkLevel(users.get(2), Level.SILVER);
        checkLevel(users.get(3), Level.GOLD);
        checkLevel(users.get(4), Level.GOLD);
    }
    
    private void checkLevel(User user, Level expectedLevel) {
        User userUpdate = userDao.get(user.getId());
        assertThat(userUpdate.getLevel(), is(expectedLevel));
    }
}

```

### UserService.add()
처음 가입하는 사용자는 기본적으로 BASIC 레벨이어야 한다.  add()를 호출할때 level 필드의 값이 null이라면 BASIC 레벨로 등록하도록 한다.